<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/plain-draggable@2.5.14/plain-draggable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leader-line-new@1.1.9/leader-line.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-panel: #111111;
            --border-color: #2a2a2a;
            --text-primary: #f5f5f5;
            --text-secondary: #a3a3a3;
            --accent-yellow: #facc15;
            --accent-yellow-hover: #fde047;
        }
        html, body { height: 100%; overflow-x: hidden; overflow-y: auto; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); }
        
        #sidebar {
            background: linear-gradient(180deg, rgba(30,30,30,0.85), rgba(10,10,10,0.85));
            border-right: 1px solid var(--border-color);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        #main-content { transition: margin-left 0.3s ease-in-out; height: 100vh; }

        /* Vista-like widget styling */
        .widget {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        .panel {
            background: var(--bg-panel);
            border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--border-color);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.5);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .panel-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; flex-shrink: 0; }
        .panel-content { flex-grow: 1; overflow: hidden; min-height: 0; display: flex; flex-direction: column; }
        
        .pro-button {
            background-color: var(--accent-yellow); color: var(--bg-primary); font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.5rem;
            transition: all 0.2s ease;
        }
        .pro-button:hover { background-color: var(--accent-yellow-hover); }
        .pro-input, .pro-select { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.875rem; color: var(--text-primary); }
        
        .main-tab { border-bottom: 2px solid transparent; }
        .main-tab.active { color: var(--accent-yellow); border-bottom-color: var(--accent-yellow); }

        /* Idea Mapper Styles */
        .idea-mapper-wrapper { position: relative; overflow: visible; background-color: var(--bg-primary); border-radius: 0.5rem; border: 1px solid var(--border-color); }
        .mapper-node {
            position: absolute;
            background: linear-gradient(135deg, rgba(42,42,42,0.6), rgba(30,30,30,0.6));
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            color: white; padding: 0.75rem 1.5rem; border-radius: 0.75rem;
            cursor: grab; user-select: none; min-width: 150px; text-align: center;
            border: 1px solid rgba(250, 204, 21, 0.3);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            z-index: 10;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .mapper-node:hover { transform: scale(1.05); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); }
        .mapper-node:active { cursor: grabbing; z-index: 11; }
        .mapper-node .delete-node {
            position: absolute; top: -8px; right: -8px; width: 20px; height: 20px;
            background-color: #ef4444; color: white; border-radius: 50%;
            display: none; align-items: center; justify-content: center;
            cursor: pointer; font-size: 14px; line-height: 20px;
            border: 2px solid var(--bg-panel);
        }
        .mapper-node:hover .delete-node { display: flex; }
        .leader-line { z-index: 5; }

        .file-toolbar { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-shrink: 0; }
        .file-toolbar button { background-color: #334155; padding: 0.25rem 0.75rem; font-size: 0.75rem; border-radius: 0.375rem; }

        /* Calendar Styles */
        .calendar { border-collapse: collapse; width: 100%; }
        .calendar th, .calendar td { text-align: center; padding: 0.5rem; border: 1px solid var(--border-color); }
        .calendar td.has-note { background-color: rgba(250, 204, 21, 0.15); position: relative; }
        .calendar td.today { outline: 2px solid var(--accent-yellow); }

        /* Day Modal */
        .modal-overlay { background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--bg-panel); }

        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-950 min-h-screen">

    <div id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-slate-900/80 backdrop-blur-lg p-4 transform -translate-x-full md:translate-x-0 flex flex-col">
        <h1 class="text-2xl font-bold mb-6 text-yellow-300">Dashboard Pro</h1>
        <div id="sidebar-tools" class="flex-grow overflow-y-auto space-y-4">
            <!-- Sidebar widgets will be injected here -->
        </div>
    </div>

    <div id="main-content" class="md:ml-72 h-full flex flex-col p-4">
        <button id="sidebar-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-slate-800 rounded-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
        <div class="flex-shrink-0 mb-4">
            <div class="flex space-x-4 border-b border-gray-700">
                <button id="editor-suite-tab-btn" class="main-tab py-2 px-4 text-lg font-semibold active">Editor</button>
                <button id="idea-mapper-tab-btn" class="main-tab py-2 px-4 text-lg font-semibold">Mapper</button>
            </div>
        </div>
        <div id="workspace" class="flex-grow relative">
            <!-- Main workspace panels will go here -->
        </div>
    </div>
    
    <!-- Panel Templates -->
    <template id="panel-template-editor-suite">
        <div class="panel h-full">
            <h2 class="panel-title">Editor Suite</h2>
            <div class="file-toolbar"><button class="file-new">New</button><button class="file-save">Save</button><button class="file-open">Open</button><button class="file-undo">Undo</button><button class="file-redo">Redo</button></div>
            <div class="editor-tabs flex space-x-1 bg-slate-700/50 p-1 rounded-lg mb-4 flex-shrink-0">
                <button data-tab="word" class="tab-button px-3 py-1 text-sm font-medium rounded-md active">Word</button>
                <button data-tab="excel" class="tab-button px-3 py-1 text-sm font-medium rounded-md">Excel</button>
                <button data-tab="calendar" class="tab-button px-3 py-1 text-sm font-medium rounded-md">Calendar</button>
            </div>
            <div class="panel-content">
                <div class="tab-content flex-grow flex flex-col" data-tab-content="word"><div class="editor-toolbar flex-shrink-0"><button onclick="document.execCommand('bold')" class="font-bold">B</button> <button onclick="document.execCommand('italic')" class="italic">I</button></div><div class="editor-container flex-grow overflow-auto" contenteditable="true"></div></div>
                <div class="tab-content hidden flex-grow flex flex-col" data-tab-content="excel"><div class="editor-container flex-grow overflow-auto"><table class="excel-grid w-full"></table></div></div>
                <div class="tab-content hidden flex-grow flex flex-col" data-tab-content="calendar"><div class="calendar-controls flex justify-between items-center mb-4"><button class="prev-month pro-button">&lt;</button><h3 class="month-year-display font-bold"></h3><div class="flex space-x-2"><button class="sync-google pro-button">Sync</button><button class="next-month pro-button">&gt;</button></div></div><table class="calendar w-full"><thead><tr><th>Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th></tr></thead><tbody></tbody></table></div>
            </div>
        </div>
    </template>
    
    <template id="panel-template-idea-mapper">
        <div class="panel h-full">
            <h2 class="panel-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C6.5,2,2,6.5,2,12S6.5,22,12,22,22,17.5,22,12,17.5,2,12,2M10,16.5V7.5L16,12L10,16.5Z"></path></svg>Idea Mapper</h2>
            <div class="file-toolbar"><button class="file-new">New</button><button class="file-save">Save</button><button class="file-open">Open</button><button class="file-undo">Undo</button><button class="file-redo">Redo</button></div>
            <div class="panel-content flex flex-col">
                <div class="mb-2 flex space-x-2 items-center flex-shrink-0"><button class="add-node-btn pro-button text-sm">Add Box</button><button class="connect-node-btn pro-button text-sm bg-slate-600">Connect</button><button class="save-map-btn pro-button text-sm bg-teal-600">Save as Image</button></div>
                <div class="idea-mapper-wrapper flex-grow"></div>
            </div>
        </div>
    </template>
    
    <template id="sidebar-tool-template">
        <div class="sidebar-tool widget p-3 rounded-lg cursor-grab">
            <h3 class="font-semibold text-yellow-300"></h3>
            <div class="sidebar-tool-content mt-2"></div>
        </div>
    </template>

    <!-- Day Dashboard Modal -->
    <div id="day-modal" class="modal-overlay fixed inset-0 w-full h-full flex items-center justify-center hidden z-50">
        <div class="modal-content w-full max-w-2xl p-6 rounded-lg shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-date-display" class="text-xl font-bold"></h3>
                <button id="modal-close-btn" class="text-2xl">&times;</button>
            </div>
            <div class="flex border-b border-slate-600 mb-4">
                <button class="modal-tab p-2 px-4 active" data-tab="notes">Notes</button>
                <button class="modal-tab p-2 px-4" data-tab="goals">Goals</button>
                <button class="modal-tab p-2 px-4" data-tab="todos">To-Do</button>
                <button class="modal-tab p-2 px-4" data-tab="reminders">Reminders</button>
            </div>
            <div class="modal-tab-content" data-tab-content="notes"><div class="flex space-x-2"><input type="text" class="pro-input flex-grow" placeholder="New note..."><button class="pro-button add-item-btn" data-type="notes">+</button></div><ul class="item-list mt-2 space-y-1" data-type="notes"></ul></div>
            <div class="modal-tab-content hidden" data-tab-content="goals"><div class="flex space-x-2"><input type="text" class="pro-input flex-grow" placeholder="New goal..."><button class="pro-button add-item-btn" data-type="goals">+</button></div><ul class="item-list mt-2 space-y-1" data-type="goals"></ul></div>
            <div class="modal-tab-content hidden" data-tab-content="todos"><div class="flex space-x-2"><input type="text" class="pro-input flex-grow" placeholder="New to-do..."><button class="pro-button add-item-btn" data-type="todos">+</button></div><ul class="item-list mt-2 space-y-1" data-type="todos"></ul></div>
            <div class="modal-tab-content hidden" data-tab-content="reminders"><div class="flex space-x-2"><input type="text" class="pro-input flex-grow reminder-text" placeholder="Reminder..."><input type="datetime-local" class="pro-input reminder-time"><button class="pro-button add-item-btn" data-type="reminders">+</button></div><ul class="item-list mt-2 space-y-1" data-type="reminders"></ul></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    if ('Notification' in window && Notification.permission !== 'granted') {
        Notification.requestPermission();
    }
    const workspace = document.getElementById('workspace');
    const sidebarToolsContainer = document.getElementById('sidebar-tools');
    
    const availableTools = [
        { id: 'data-analysis', name: 'Data Analysis' },
        { id: 'quick-links', name: 'Quick Links' },
        { id: 'quick-note', name: 'Quick Note' },
        { id: 'calculator', name: 'Calculator' },
        { id: 'custom-html', name: 'Custom HTML' },
    ];

    // --- Core Dashboard Logic ---
    const dashboardModule = (() => {
        const renderSidebarTools = () => {
            availableTools.forEach(tool => {
                const template = document.getElementById('sidebar-tool-template');
                const toolNode = template.content.cloneNode(true).firstElementChild;
                toolNode.querySelector('h3').textContent = tool.name;
                toolNode.dataset.toolId = tool.id;
                const content = toolNode.querySelector('.sidebar-tool-content');

                switch (tool.id) {
                    case 'quick-note':
                        content.innerHTML = `<div class="note-wrapper h-32 bg-slate-700 rounded-md overflow-hidden"><div class="note h-full"><textarea class="note-textarea w-full h-full bg-transparent border-none focus:outline-none resize-none p-2" placeholder="Type..."></textarea></div></div><button class="save-note-btn pro-button w-full mt-2">Save</button><ul class="saved-notes mt-2 space-y-1 text-xs"></ul>`;
                        quickNoteModule.init(toolNode);
                        break;
                    case 'calculator':
                        content.innerHTML = `<div class="calculator-display bg-slate-800 rounded-md p-2 text-right text-xl mb-2">0</div><div class="calculator-grid grid grid-cols-4 gap-2"></div>`;
                        calculatorModule.init(toolNode);
                        break;
                    case 'quick-links':
                        content.innerHTML = `<div class="flex space-x-1 mb-2"><input type="text" class="link-name pro-input flex-grow" placeholder="Name"><input type="url" class="link-url pro-input flex-grow" placeholder="URL"><button class="add-link-btn pro-button">+</button></div><div class="links-list space-y-1"></div>`;
                        quickLinksModule.init(toolNode);
                        break;
                    case 'data-analysis':
                        content.innerHTML = `<textarea class="data-input pro-input w-full h-24 mb-2" placeholder="Enter numbers separated by commas"></textarea><button class="analyze-btn pro-button w-full mb-2">Analyze</button><div class="analysis-result text-sm text-slate-400"></div>`;
                        dataAnalysisModule.init(toolNode);
                        break;
                    case 'custom-html':
                        content.innerHTML = `<textarea class="html-input pro-input w-full h-24 mb-2" placeholder="<p>Custom HTML</p>"></textarea><button class="render-btn pro-button w-full mb-2">Render</button><div class="html-preview mt-2"></div>`;
                        customHTMLModule.init(toolNode);
                        break;
                }

                sidebarToolsContainer.appendChild(toolNode);
            });
        };

        const setActiveTab = (tab) => {
            workspace.innerHTML = '';
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`${tab}-tab-btn`).classList.add('active');
            
            const template = document.getElementById(`panel-template-${tab}`);
            if (template) {
                const panelNode = template.content.cloneNode(true).firstElementChild;
                workspace.appendChild(panelNode);
                if (panelInitializers[tab]) {
                    panelInitializers[tab](panelNode);
                }
            }
        };

        document.getElementById('editor-suite-tab-btn').onclick = () => setActiveTab('editor-suite');
        document.getElementById('idea-mapper-tab-btn').onclick = () => setActiveTab('idea-mapper');
        document.getElementById('sidebar-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('-translate-x-full'));
        
        return { init: () => { renderSidebarTools(); setActiveTab('editor-suite'); } };
    })();

    // --- Panel Initializers ---
    const panelInitializers = {
        'editor-suite': (panelNode) => {
            const tabs = panelNode.querySelector('.editor-tabs');
            const contents = panelNode.querySelectorAll('.tab-content');
            tabs.addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') {
                    const tabName = e.target.dataset.tab;
                    tabs.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    contents.forEach(c => c.classList.toggle('hidden', c.dataset.tabContent !== tabName));
                }
            });

            const toolbar = panelNode.querySelector('.file-toolbar');
            const wordEditor = panelNode.querySelector('[data-tab-content="word"] .editor-container');
            const excelGrid = panelNode.querySelector('.excel-grid');
            const activeTab = () => panelNode.querySelector('.editor-tabs .active').dataset.tab;

            toolbar.querySelector('.file-new').onclick = () => {
                const tab = activeTab();
                if (tab === 'word') {
                    wordEditor.innerHTML = '';
                } else if (tab === 'excel') {
                    excelGrid.querySelectorAll('td').forEach(td => td.textContent = '');
                }
            };

            toolbar.querySelector('.file-save').onclick = () => {
                const tab = activeTab();
                if (tab === 'word') {
                    const blob = new Blob([wordEditor.innerHTML], { type: 'text/html' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'document.html';
                    a.click();
                    URL.revokeObjectURL(a.href);
                } else if (tab === 'excel') {
                    const rows = [];
                    excelGrid.querySelectorAll('tr').forEach((tr, idx) => {
                        if (idx === 0) return;
                        const cols = [];
                        tr.querySelectorAll('td').forEach(td => cols.push(td.textContent));
                        rows.push(cols.join(','));
                    });
                    const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'sheet.csv';
                    a.click();
                    URL.revokeObjectURL(a.href);
                }
            };

            toolbar.querySelector('.file-open').onclick = () => {
                const tab = activeTab();
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = tab === 'word' ? '.txt,.html' : '.csv';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = ev => {
                        if (tab === 'word') {
                            wordEditor.innerHTML = ev.target.result;
                        } else if (tab === 'excel') {
                            const lines = ev.target.result.split(/\r?\n/);
                            excelGrid.querySelectorAll('tr').forEach((tr, rIdx) => {
                                if (rIdx === 0) return;
                                const cells = lines[rIdx - 1] ? lines[rIdx - 1].split(',') : [];
                                tr.querySelectorAll('td').forEach((td, cIdx) => td.textContent = cells[cIdx] || '');
                            });
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };

            toolbar.querySelector('.file-undo').onclick = () => document.execCommand('undo');
            toolbar.querySelector('.file-redo').onclick = () => document.execCommand('redo');

            excelModule.init(excelGrid);
            calendarModule.init(panelNode);
        },
        'idea-mapper': (panelNode) => ideaMapperModule.init(panelNode),
    };
    
    // --- Day Dashboard Modal Module ---
    const dayDashboardModule = (() => {
        const modal = document.getElementById('day-modal');
        let calendarData = JSON.parse(localStorage.getItem('calendarData')) || {};
        let activeDateKey = '';
        const save = () => localStorage.setItem('calendarData', JSON.stringify(calendarData));

        const scheduleReminder = (dateKey, reminder) => {
            if (!('Notification' in window)) return;
            const when = new Date(`${dateKey}T${reminder.time}`);
            const timeout = when.getTime() - Date.now();
            if (timeout > 0) {
                setTimeout(() => {
                    new Notification('Reminder', { body: reminder.text });
                }, timeout);
            }
        };

        const renderItems = (type) => {
            const ul = modal.querySelector(`ul[data-type="${type}"]`);
            ul.innerHTML = '';
            const items = (calendarData[activeDateKey] && calendarData[activeDateKey][type]) ? calendarData[activeDateKey][type] : [];
            items.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-slate-700 p-2 rounded';
                const display = type === 'reminders'
                    ? `${item.text} (${new Date(item.time).toLocaleString()})`
                    : item;
                li.textContent = display;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-400 font-bold px-2';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = () => {
                    calendarData[activeDateKey][type].splice(index, 1);
                    save(); renderItems(type);
                };
                li.appendChild(deleteBtn);
                ul.appendChild(li);
            });
        };

        Object.entries(calendarData).forEach(([dateKey, types]) => {
            (types.reminders || []).forEach(r => scheduleReminder(dateKey, r));
        });
        modal.querySelectorAll('.add-item-btn').forEach(btn => {
            btn.onclick = () => {
                const type = btn.dataset.type;
                const container = btn.parentElement;
                const textInput = container.querySelector('.reminder-text') || container.querySelector('input[type="text"]');
                const timeInput = container.querySelector('.reminder-time');
                if (type === 'reminders') {
                    if (textInput.value.trim() && timeInput.value) {
                        if (!calendarData[activeDateKey]) calendarData[activeDateKey] = {};
                        if (!calendarData[activeDateKey][type]) calendarData[activeDateKey][type] = [];
                        const reminder = { text: textInput.value.trim(), time: timeInput.value };
                        calendarData[activeDateKey][type].push(reminder);
                        scheduleReminder(activeDateKey, reminder);
                        textInput.value = '';
                        timeInput.value = '';
                        save();
                        renderItems(type);
                        document.dispatchEvent(new Event('calendar:dataupdated'));
                    }
                } else {
                    if (textInput.value.trim()) {
                        if (!calendarData[activeDateKey]) calendarData[activeDateKey] = {};
                        if (!calendarData[activeDateKey][type]) calendarData[activeDateKey][type] = [];
                        calendarData[activeDateKey][type].push(textInput.value.trim());
                        textInput.value = '';
                        save();
                        renderItems(type);
                        document.dispatchEvent(new Event('calendar:dataupdated'));
                    }
                }
            };
        });

        modal.querySelectorAll('.modal-tab').forEach(tab => {
            tab.onclick = () => {
                modal.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                modal.querySelectorAll('.modal-tab-content').forEach(c => c.classList.add('hidden'));
                modal.querySelector(`.modal-tab-content[data-tab-content="${tab.dataset.tab}"]`).classList.remove('hidden');
            };
        });
        
        document.getElementById('modal-close-btn').onclick = () => modal.classList.add('hidden');

        return {
            show: (dateKey) => {
                activeDateKey = dateKey;
                document.getElementById('modal-date-display').textContent = new Date(dateKey.replace(/-/g, '/')).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                modal.querySelector('.modal-tab').click(); // Reset to first tab
                ['notes', 'goals', 'todos', 'reminders'].forEach(renderItems);
                modal.classList.remove('hidden');
            }
        };
    })();

    const googleCalendarModule = (() => {
        const CLIENT_ID = 'YOUR_CLIENT_ID';
        const API_KEY = 'YOUR_API_KEY';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
        let tokenClient;
        let gapiInited = false;

        const loadGapiClient = () => new Promise(resolve => {
            gapi.load('client', async () => {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
                gapiInited = true;
                resolve();
            });
        });

        const sync = async (calendarData, currentDate) => {
            if (!gapiInited) await loadGapiClient();
            if (!tokenClient) {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: ''
                });
            }
            tokenClient.callback = async (resp) => {
                if (resp.error) return;
                const start = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString();
                const end = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).toISOString();
                const events = await gapi.client.calendar.events.list({
                    calendarId: 'primary',
                    timeMin: start,
                    timeMax: end,
                    showDeleted: false,
                    singleEvents: true,
                    orderBy: 'startTime'
                });
                events.result.items.forEach(ev => {
                    const dateStr = ev.start.date || ev.start.dateTime.split('T')[0];
                    const parts = dateStr.split('-').map(Number);
                    const dateKey = `${parts[0]}-${parts[1]}-${parts[2]}`;
                    if (!calendarData[dateKey]) calendarData[dateKey] = {};
                    if (!calendarData[dateKey].events) calendarData[dateKey].events = [];
                    calendarData[dateKey].events.push(ev.summary || 'Event');
                });
                localStorage.setItem('calendarData', JSON.stringify(calendarData));
                document.dispatchEvent(new Event('calendar:dataupdated'));
            };
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        };

        return { sync };
    })();

    // --- Calendar Module ---
    const calendarModule = (() => {
        let currentDate = new Date();
        let calendarData = {};
        let panelNode;

        currentDate.setDate(1);

        const load = () => { calendarData = JSON.parse(localStorage.getItem('calendarData')) || {}; };

        const render = () => {
            load();
            const calendarBody = panelNode.querySelector('.calendar tbody');
            const monthYearDisplay = panelNode.querySelector('.month-year-display');
            if (!calendarBody || !monthYearDisplay) return;

            calendarBody.innerHTML = '';
            const month = currentDate.getMonth(), year = currentDate.getFullYear();
            monthYearDisplay.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
            const firstDayIndex = new Date(year, month, 1).getDay();
            const lastDay = new Date(year, month + 1, 0).getDate();
            
            let date = 1;
            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');
                    if (i === 0 && j < firstDayIndex || date > lastDay) { /* empty */ } 
                    else {
                        const dateKey = `${year}-${month + 1}-${date}`;
                        cell.textContent = date; cell.dataset.dateKey = dateKey;
                        if (calendarData[dateKey] && Object.values(calendarData[dateKey]).some(arr => arr.length > 0)) {
                            cell.classList.add('has-note');
                        }
                        if (date === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) {
                            cell.classList.add('today');
                        }
                        date++;
                    }
                    row.appendChild(cell);
                }
                calendarBody.appendChild(row);
                if (date > lastDay) break;
            }
        };

        return {
            init: (node) => {
                panelNode = node;
                render();
                panelNode.querySelector('.prev-month').onclick = () => {
                    currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
                    render();
                };
                panelNode.querySelector('.next-month').onclick = () => {
                    currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
                    render();
                };
                panelNode.querySelector('.sync-google').onclick = () => { googleCalendarModule.sync(calendarData, currentDate); };
                panelNode.querySelector('.calendar tbody').onclick = (e) => {
                    if (e.target.tagName === 'TD' && e.target.dataset.dateKey) {
                        dayDashboardModule.show(e.target.dataset.dateKey);
                    }
                };
                document.addEventListener('calendar:dataupdated', () => render());
            }
        };
    })();

    // --- Excel Module ---
    const excelModule = {
        init: (grid) => {
            if (!grid) return;
            // Create headers
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th></th>' + Array.from({length: 10}, (_, i) => `<th>${String.fromCharCode(65 + i)}</th>`).join('');
            grid.appendChild(headerRow);
            // Create rows
            for(let i = 1; i <= 20; i++) {
                const row = document.createElement('tr');
                row.innerHTML = `<th>${i}</th>` + Array.from({length: 10}, () => `<td contenteditable="true" class="border border-slate-600 p-1"></td>`).join('');
                grid.appendChild(row);
            }
        }
    };

    // --- Idea Mapper Module (using libraries) ---
    const ideaMapperModule = (() => {
        let wrapper, panelRef, nodes = [], connectors = [], lines = [];
        let history = [], future = [];
        let state = { connecting: false, startNode: null };

        const pushState = () => {
            history.push(JSON.stringify({ nodes, connectors }));
            if (history.length > 50) history.shift();
            future = [];
        };

        const save = () => localStorage.setItem('mapperData', JSON.stringify({ nodes, connectors }));
        const load = () => {
            const data = JSON.parse(localStorage.getItem('mapperData'));
            if (data && data.nodes && data.nodes.length) {
                nodes = data.nodes; connectors = data.connectors || [];
            } else {
                nodes = [{ id: `node-${Date.now()}`, x: 50, y: 50, text: 'Start Here' }];
            }
            render();
            pushState();
        };
        
        const addNode = (nodeData) => {
            const nodeEl = document.createElement('div');
            nodeEl.id = nodeData.id;
            nodeEl.className = 'mapper-node';
            nodeEl.style.left = `${nodeData.x}px`;
            nodeEl.style.top = `${nodeData.y}px`;
            nodeEl.innerHTML = `<div class="node-text" contenteditable="true">${nodeData.text}</div>`;
            const textEl = nodeEl.querySelector('.node-text');
            textEl.addEventListener('click', e => e.stopPropagation());
            textEl.addEventListener('input', () => {
                const node = nodes.find(n => n.id === nodeData.id);
                if (node) { node.text = textEl.textContent; save(); }
            });

            nodeEl.addEventListener('click', () => {
                if (state.connecting) {
                    if (!state.startNode) {
                        state.startNode = nodeEl;
                        nodeEl.style.boxShadow = '0 0 0 3px #34d399';
                    } else if (state.startNode !== nodeEl) {
                        pushState();
                        connectors.push({ from: state.startNode.id, to: nodeEl.id });
                        drawConnectors(); save();
                        panelRef.querySelector('.connect-node-btn').click();
                    }
                }
            });

            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'delete-node';
            deleteBtn.textContent = 'Ã—';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                pushState();
                wrapper.removeChild(nodeEl);
                nodes = nodes.filter(n => n.id !== nodeData.id);
                connectors = connectors.filter(c => c.from !== nodeData.id && c.to !== nodeData.id);
                drawConnectors();
                save();
            };
            nodeEl.appendChild(deleteBtn);
            wrapper.appendChild(nodeEl);

            new PlainDraggable(nodeEl, {
                containment: wrapper,
                onDragStart: () => pushState(),
                onMove: () => lines.forEach(l => l.position()),
                onDragEnd: (e) => {
                    const node = nodes.find(n => n.id === e.target.id);
                    if (node) {
                        node.x = e.left;
                        node.y = e.top;
                        save();
                    }
                }
            });
        };

        const render = () => {
            if (!wrapper) return;
            wrapper.innerHTML = ''; // Clear previous nodes
            lines.forEach(line => line.remove()); lines = [];
            nodes.forEach(addNode);
            drawConnectors();
        };

        const drawConnectors = () => {
            lines.forEach(line => line.remove()); lines = [];
            connectors.forEach(conn => {
                const from = document.getElementById(conn.from), to = document.getElementById(conn.to);
                if (from && to) {
                    lines.push(new LeaderLine(from, to, { color: '#94a3b8', size: 2, path: 'straight', startSocket: 'auto', endSocket: 'auto' }));
                }
            });
        };

        return {
            init: (panelNode) => {
                panelRef = panelNode;
                wrapper = panelNode.querySelector('.idea-mapper-wrapper');
                const toolbar = panelNode.querySelector('.file-toolbar');
                panelNode.querySelector('.add-node-btn').onclick = () => {
                    pushState();
                    const newNodeData = { id: `node-${Date.now()}`, x: 20, y: 20, text: 'New Idea' };
                    nodes.push(newNodeData);
                    addNode(newNodeData);
                    save();
                };
                panelNode.querySelector('.connect-node-btn').onclick = (e) => {
                    state.connecting = !state.connecting;
                    e.target.classList.toggle('bg-green-500', state.connecting);
                    e.target.classList.toggle('bg-slate-600', !state.connecting);
                    if (!state.connecting && state.startNode) {
                        state.startNode.style.boxShadow = ''; state.startNode = null;
                    }
                };
                panelNode.querySelector('.save-map-btn').onclick = () => {
                    html2canvas(wrapper, { backgroundColor: '#1e293b' }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = 'idea-map.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    });
                };
                toolbar.querySelector('.file-new').onclick = () => {
                    pushState();
                    nodes = [{ id: `node-${Date.now()}`, x: 50, y: 50, text: 'Start Here' }];
                    connectors = [];
                    render();
                    save();
                };
                toolbar.querySelector('.file-save').onclick = () => {
                    const blob = new Blob([JSON.stringify({ nodes, connectors })], { type: 'application/json' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'idea-map.json';
                    a.click();
                    URL.revokeObjectURL(a.href);
                };
                toolbar.querySelector('.file-open').onclick = () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = e => {
                        const file = e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = ev => {
                            pushState();
                            const data = JSON.parse(ev.target.result);
                            nodes = data.nodes || [];
                            connectors = data.connectors || [];
                            render();
                            save();
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                };
                toolbar.querySelector('.file-undo').onclick = () => {
                    if (!history.length) return;
                    future.push(JSON.stringify({ nodes, connectors }));
                    const prev = JSON.parse(history.pop());
                    nodes = prev.nodes || [];
                    connectors = prev.connectors || [];
                    render();
                    save();
                };
                toolbar.querySelector('.file-redo').onclick = () => {
                    if (!future.length) return;
                    history.push(JSON.stringify({ nodes, connectors }));
                    const next = JSON.parse(future.pop());
                    nodes = next.nodes || [];
                    connectors = next.connectors || [];
                    render();
                    save();
                };
                load();
            }
        };
    })();

    // --- Other Modules ---
    const quickLinksModule = { init: (node) => {
        node.querySelector('.add-link-btn').onclick = () => {
            const nameEl = node.querySelector('.link-name'), urlEl = node.querySelector('.link-url');
            if (nameEl.value && urlEl.value) {
                const a = document.createElement('a');
                a.href = urlEl.value; a.target = "_blank";
                a.className = 'block p-2 bg-slate-700/50 rounded-md text-center text-sm hover:bg-slate-600/50 truncate';
                a.textContent = nameEl.value;
                node.querySelector('.links-list').appendChild(a);
                nameEl.value = ''; urlEl.value = '';
            }
        };
    } };
    const quickNoteModule = { init: (node) => {
        const list = node.querySelector('.saved-notes');
        const textarea = node.querySelector('.note-textarea');
        const load = () => {
            const notes = JSON.parse(localStorage.getItem('quickNotes')) || [];
            list.innerHTML = '';
            notes.forEach((n, i) => {
                const li = document.createElement('li');
                li.textContent = n;
                li.className = 'bg-slate-800 p-1 rounded';
                list.appendChild(li);
            });
        };
        load();
        node.querySelector('.save-note-btn').onclick = () => {
            if (textarea.value.trim() === '') return;
            const notes = JSON.parse(localStorage.getItem('quickNotes')) || [];
            notes.push(textarea.value.trim());
            localStorage.setItem('quickNotes', JSON.stringify(notes));
            textarea.value = '';
            load();
        };
    } };
    const calculatorModule = { init: (node) => {
        const display = node.querySelector('.calculator-display');
        const grid = node.querySelector('.calculator-grid');
        const module = {
            clear: () => { display.textContent = '0'; },
            input: (val) => {
                if (display.textContent === '0' || display.textContent === 'Error') display.textContent = '';
                if (display.textContent.length > 15) return;
                display.textContent += val;
            },
            equals: () => {
                try { display.textContent = parseFloat(eval(display.textContent.replace(/[^-()\d/*+.]/g, '')).toFixed(5)); } 
                catch (e) { display.textContent = 'Error'; }
            }
        };
        grid.innerHTML = `<button class="pro-button p-2 text-xl">C</button><button class="pro-button p-2 text-xl">(</button><button class="pro-button p-2 text-xl">)</button><button class="pro-button operator p-2 text-xl">/</button>`;
        ['7','8','9','*','4','5','6','-','1','2','3','+','0','.'].forEach(k => {
            const op = '/*-+'.includes(k);
            grid.innerHTML += `<button class="pro-button ${op ? 'operator' : ''} p-2 text-xl">${k}</button>`;
        });
        grid.innerHTML += `<button class="pro-button operator col-span-2 p-2 text-xl">=</button>`;
        grid.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                const key = e.target.textContent;
                if(key === 'C') module.clear();
                else if (key === '=') module.equals();
                else module.input(key);
            }
        });
    } };

    const dataAnalysisModule = { init: (node) => {
        const input = node.querySelector('.data-input');
        const result = node.querySelector('.analysis-result');
        node.querySelector('.analyze-btn').onclick = () => {
            const numbers = input.value.split(/[,\s]+/).map(Number).filter(n => !isNaN(n));
            if (numbers.length === 0) {
                result.textContent = 'Enter valid numbers';
                return;
            }
            const sum = numbers.reduce((a, b) => a + b, 0);
            const avg = sum / numbers.length;
            result.textContent = `Count: ${numbers.length} Sum: ${sum} Avg: ${avg}`;
        };
    } };

    const customHTMLModule = { init: (node) => {
        const input = node.querySelector('.html-input');
        const preview = node.querySelector('.html-preview');
        node.querySelector('.render-btn').onclick = () => {
            preview.innerHTML = input.value;
        };
    } };

    // --- Initialize Dashboard ---
    dashboardModule.init();
});
</script>

</body>
</html>

