<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Dashboard - Final Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- New Libraries for a stable Idea Mapper -->
    <script src="https://cdn.jsdelivr.net/npm/plain-draggable@2.5.14/plain-draggable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leader-line-new@1.1.9/leader-line.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @keyframes aurora { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0;
            background-image: radial-gradient(at 20% 20%, hsla(212, 90%, 30%, 0.2) 0px, transparent 50%), radial-gradient(at 80% 20%, hsla(288, 70%, 40%, 0.2) 0px, transparent 50%), radial-gradient(at 20% 80%, hsla(168, 80%, 40%, 0.2) 0px, transparent 50%), radial-gradient(at 80% 80%, hsla(348, 80%, 50%, 0.2) 0px, transparent 50%);
            background-size: 200% 200%; animation: aurora 40s ease-in-out infinite;
        }
        #sidebar { transition: transform 0.3s ease-in-out; z-index: 50; }
        #main-content { transition: margin-left 0.3s ease-in-out; height: 100vh; }
        .panel {
            background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: 1rem; padding: 1.5rem; border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.2);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .panel-title {
            font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #cbd5e1;
            text-transform: uppercase; letter-spacing: 0.05em;
            display: flex; align-items: center; flex-shrink: 0;
        }
        .panel-title svg { width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; }
        .panel-content { 
            flex-grow: 1; 
            overflow: hidden;
            min-height: 0; /* CRITICAL FIX for flexbox children */
            display: flex;
            flex-direction: column;
        }
        .pro-button {
            background: rgba(79, 70, 229, 0.8); color: white; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.5rem;
            transition: all 0.2s ease; border: 1px solid transparent; display: inline-flex; align-items: center; justify-content: center;
        }
        .pro-button:hover { background: rgba(99, 102, 241, 0.9); box-shadow: 0 0 15px rgba(99, 102, 241, 0.5); }
        .pro-input, .pro-select {
             background-color: rgba(51, 65, 85, 0.7); border: 1px solid #475569;
             border-radius: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.875rem; color: #e2e8f0;
        }
        .tab-button.active { background-color: #4f46e5; color: white; }
        
        /* Calendar Styles */
        .calendar { text-align: center; } .calendar th { color: #94a3b8; }
        .calendar td { padding: 0.5rem; cursor: pointer; border-radius: 9999px; position: relative; }
        .calendar td:hover { background-color: rgba(79, 70, 229, 0.5); }
        .calendar .today { background-color: #4f46e5; color: white; }
        .calendar .has-note::after {
            content: ''; position: absolute; bottom: 6px; left: 50%;
            transform: translateX(-50%); width: 5px; height: 5px;
            background-color: #facc15; border-radius: 50%;
        }
        
        /* Modal Styles */
        .modal-overlay { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal-content { background-color: #1e293b; }
        .modal-tab.active { background-color: #4f46e5; color: white; }

        /* Idea Mapper Styles */
        .idea-mapper-wrapper { position: relative; overflow: hidden; background-color: rgba(51, 65, 85, 0.5); border-radius: 0.5rem; }
        .mapper-node {
            position: absolute; background-color: #4f46e5; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem;
            cursor: grab; user-select: none; min-width: 150px; text-align: center; border: 1px solid #6366f1;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 10;
        }
        .mapper-node:active { cursor: grabbing; z-index: 11; }
        .leader-line { z-index: 5; }

        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-950 min-h-screen">

    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-slate-900/80 backdrop-blur-lg p-4 transform -translate-x-full md:translate-x-0">
        <h1 class="text-2xl font-bold mb-6">Dashboard</h1>
        <h2 class="text-sm font-semibold text-slate-400 mb-2 uppercase">Panels</h2>
        <div id="panel-toggle-list" class="space-y-2"></div>
    </div>

    <div id="main-content" class="md:ml-64 min-h-full">
        <button id="sidebar-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 bg-slate-800 rounded-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
        <div id="dashboard-grid" class="p-4 grid grid-cols-1 lg:grid-cols-4 gap-6 min-h-full" style="grid-template-rows: 2fr 1fr;"></div>
    </div>
    
    <!-- Panel Templates -->
    <template id="panel-template-editor-suite">
        <div class="panel lg:col-span-2 lg:row-span-1">
            <h2 class="panel-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17.25,3.3C16.7,2.75,15.82,2.75,15.27,3.3L6.09,12.48L2,18.59L5.41,22L11.52,17.91L20.7,8.73C21.25,8.18,21.25,7.3,20.7,6.75L17.25,3.3M16.06,7.92L14.59,9.39L16.5,11.3L18.41,9.39L16.5,7.47L14.59,5.56L16.06,4.09L18.41,6.44L16.06,7.92Z"></path></svg>Editor Suite</h2>
            <div class="editor-tabs flex space-x-1 bg-slate-700/50 p-1 rounded-lg mb-4 flex-shrink-0">
                <button data-tab="word" class="tab-button px-3 py-1 text-sm font-medium rounded-md active">Word</button>
                <button data-tab="excel" class="tab-button px-3 py-1 text-sm font-medium rounded-md">Excel</button>
                <button data-tab="calendar" class="tab-button px-3 py-1 text-sm font-medium rounded-md">Calendar</button>
            </div>
            <div class="panel-content">
                <div class="tab-content flex-grow flex flex-col" data-tab-content="word">
                    <div class="editor-toolbar flex-shrink-0"><button onclick="document.execCommand('bold')" class="font-bold">B</button> <button onclick="document.execCommand('italic')" class="italic">I</button></div>
                    <div class="editor-container flex-grow overflow-auto" contenteditable="true"></div>
                </div>
                <div class="tab-content hidden flex-grow flex flex-col" data-tab-content="excel">
                    <div class="editor-container flex-grow overflow-auto"><table class="excel-grid w-full"></table></div>
                </div>
                <div class="tab-content hidden flex-grow flex flex-col" data-tab-content="calendar">
                    <div class="calendar-controls flex justify-between items-center mb-4"><button class="prev-month pro-button">&lt;</button><h3 class="month-year-display font-bold"></h3><button class="next-month pro-button">&gt;</button></div>
                    <table class="calendar w-full"><thead><tr><th>Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>
    </template>
    
    <template id="panel-template-idea-mapper">
        <div class="panel lg:col-span-2 lg:row-span-1">
            <h2 class="panel-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C6.5,2,2,6.5,2,12S6.5,22,12,22,22,17.5,22,12,17.5,2,12,2M10,16.5V7.5L16,12L10,16.5Z"></path></svg>Idea Mapper</h2>
            <div class="panel-content flex flex-col">
                <div class="mb-2 flex space-x-2 items-center flex-shrink-0">
                    <button class="add-node-btn pro-button text-sm">Add Box</button>
                    <button class="connect-node-btn pro-button text-sm bg-slate-600">Connect</button>
                    <button class="save-map-btn pro-button text-sm bg-teal-600">Save as Image</button>
                </div>
                <div class="idea-mapper-wrapper flex-grow">
                    <!-- Nodes will be added here by JS -->
                </div>
            </div>
        </div>
    </template>
    
    <template id="panel-template-data-analysis">
        <div class="panel lg:col-span-1 lg:row-span-1">
            <h2 class="panel-title"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M22,21H2V3H4V19H6V10H8V19H10V14H12V19H14V11H16V19H18V7H20V19H22V21Z"></path></svg>Data Analysis</h2>
            <div class="panel-content flex flex-col space-y-4">
                <div class="h-48 flex-shrink-0"><canvas class="crm-chart"></canvas></div>
                <div class="flex-grow flex flex-col space-y-2">
                    <div class="flex space-x-2"><input class="crm-label pro-input flex-grow" placeholder="Label"><input class="crm-value pro-input w-24" type="number" placeholder="Value"></div>
                    <button class="add-data-btn pro-button w-full">Add Data</button>
                    <div class="crm-list flex-grow overflow-y-auto h-24 space-y-1 pr-2"></div>
                </div>
            </div>
        </div>
    </template>

    <template id="panel-template-quick-links"><div class="panel lg:col-span-1 lg:row-span-1"><h2 class="panel-title">Quick Links</h2><div class="panel-content flex flex-col space-y-4"><div class="flex space-x-2"><input class="link-name pro-input flex-1" placeholder="Name"><input class="link-url pro-input flex-1" placeholder="URL"></div><button class="add-link-btn pro-button w-full">Add</button><div class="links-list grid grid-cols-2 gap-2 flex-grow overflow-y-auto"></div></div></div></template>
    <template id="panel-template-quick-note"><div class="panel lg:col-span-1 lg:row-span-1"><h2 class="panel-title">Quick Note</h2><div class="panel-content flex flex-col"><div class="note-wrapper flex-grow relative"><div class="note absolute inset-0"><textarea class="note-textarea w-full h-full bg-transparent border-none focus:outline-none resize-none p-2" placeholder="Type..."></textarea></div></div><button class="save-note-btn mt-4 w-full pro-button bg-yellow-400 hover:bg-yellow-500 text-slate-800">Save & New</button></div></div></template>
    <template id="panel-template-calculator"><div class="panel lg:col-span-1 lg:row-span-1"><h2 class="panel-title">Calculator</h2><div class="panel-content flex flex-col space-y-2"><div class="calculator-display bg-slate-900/50 text-right text-3xl font-mono p-4 rounded-md">0</div><div class="calculator-grid grid grid-cols-4 gap-2 flex-grow"></div></div></div></template>
    <template id="panel-template-custom-html"><div class="panel lg:col-span-1 lg:row-span-1"><h2 class="panel-title">Custom HTML</h2><div class="panel-content flex flex-col space-y-2"><textarea class="html-input pro-input flex-grow h-32 resize-none" placeholder="Paste HTML..."></textarea><button class="render-html-btn pro-button">Render</button><div class="flex-grow border border-slate-600 rounded-md mt-2"><iframe class="custom-html-iframe w-full h-full border-none"></iframe></div></div></div></template>

    <!-- Day Dashboard Modal -->
    <div id="day-modal" class="modal-overlay fixed inset-0 w-full h-full flex items-center justify-center hidden z-50">
        <div class="modal-content w-full max-w-2xl p-6 rounded-lg shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-date-display" class="text-xl font-bold"></h3>
                <button id="modal-close-btn" class="text-2xl">&times;</button>
            </div>
            <div class="flex border-b border-slate-600 mb-4">
                <button class="modal-tab p-2 px-4 active" data-tab="notes">Notes</button>
                <button class="modal-tab p-2 px-4" data-tab="goals">Goals</button>
                <button class="modal-tab p-2 px-4" data-tab="todos">To-Do</button>
                <button class="modal-tab p-2 px-4" data-tab="reminders">Reminders</button>
            </div>
            <div class="modal-tab-content" data-tab-content="notes"><div class="flex space-x-2"><input type="text" class="pro-input flex-grow" placeholder="New note..."><button class="pro-button add-item-btn" data-type="notes">+</button></div><ul class="item-list mt-2 space-y-1" data-type="notes"></ul></div>
            <div class="modal-tab-content hidden" data-tab-content="goals"><div class="flex space-x-2"><input type="text" class="pro-input flex-grow" placeholder="New goal..."><button class="pro-button add-item-btn" data-type="goals">+</button></div><ul class="item-list mt-2 space-y-1" data-type="goals"></ul></div>
            <div class="modal-tab-content hidden" data-tab-content="todos"><div class="flex space-x-2"><input type="text" class="pro-input flex-grow" placeholder="New to-do..."><button class="pro-button add-item-btn" data-type="todos">+</button></div><ul class="item-list mt-2 space-y-1" data-type="todos"></ul></div>
            <div class="modal-tab-content hidden" data-tab-content="reminders"><div class="flex space-x-2"><input type="text" class="pro-input flex-grow" placeholder="New reminder..."><button class="pro-button add-item-btn" data-type="reminders">+</button></div><ul class="item-list mt-2 space-y-1" data-type="reminders"></ul></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const dashboardGrid = document.getElementById('dashboard-grid');
    const panelToggleList = document.getElementById('panel-toggle-list');
    
    const availablePanels = [
        { id: 'editor-suite', name: 'Editor Suite', default: true, colSpan: 2, rowSpan: 1 },
        { id: 'idea-mapper', name: 'Idea Mapper', default: true, colSpan: 2, rowSpan: 1 },
        { id: 'data-analysis', name: 'Data Analysis', default: true, colSpan: 1, rowSpan: 1 },
        { id: 'quick-links', name: 'Quick Links', default: true, colSpan: 1, rowSpan: 1 },
        { id: 'quick-note', name: 'Quick Note', default: true, colSpan: 1, rowSpan: 1 },
        { id: 'calculator', name: 'Calculator', default: true, colSpan: 1, rowSpan: 1 },
        { id: 'custom-html', name: 'Custom HTML', default: false, colSpan: 2, rowSpan: 1 },
    ];
    let activePanels = {};

    // --- Core Dashboard Logic ---
    const dashboardModule = (() => {
        const loadState = () => {
            const savedState = localStorage.getItem('dashboardState');
            if (savedState) {
                activePanels = JSON.parse(savedState);
            } else {
                availablePanels.forEach(p => { activePanels[p.id] = p.default; });
            }
        };
        const saveState = () => localStorage.setItem('dashboardState', JSON.stringify(activePanels));
        const renderDashboard = () => {
            dashboardGrid.innerHTML = '';
            availablePanels.forEach(panelInfo => {
                if (activePanels[panelInfo.id]) {
                    const template = document.getElementById(`panel-template-${panelInfo.id}`);
                    if (template) {
                        const panelNode = template.content.cloneNode(true).firstElementChild;
                        panelNode.id = `panel-${panelInfo.id}`;
                        panelNode.className += ` lg:col-span-${panelInfo.colSpan} lg:row-span-${panelInfo.rowSpan}`;
                        dashboardGrid.appendChild(panelNode);
                        if (panelInitializers[panelInfo.id]) {
                            panelInitializers[panelInfo.id](panelNode);
                        }
                    }
                }
            });
        };
        const renderToggles = () => {
            panelToggleList.innerHTML = '';
            availablePanels.forEach(panel => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-slate-700';
                label.innerHTML = `<input type="checkbox" data-panel-id="${panel.id}" class="form-checkbox h-5 w-5 rounded bg-slate-700 border-slate-600 text-indigo-600 focus:ring-indigo-500" ${activePanels[panel.id] ? 'checked' : ''}><span>${panel.name}</span>`;
                panelToggleList.appendChild(label);
            });
        };
        panelToggleList.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                activePanels[e.target.dataset.panelId] = e.target.checked;
                saveState(); renderDashboard();
            }
        });
        document.getElementById('sidebar-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('-translate-x-full'));
        
        return { init: () => { loadState(); renderToggles(); renderDashboard(); } };
    })();

    // --- Panel Initializers ---
    const panelInitializers = {
        'editor-suite': (panelNode) => {
            const tabs = panelNode.querySelector('.editor-tabs');
            const contents = panelNode.querySelectorAll('.tab-content');
            tabs.addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') {
                    const tabName = e.target.dataset.tab;
                    tabs.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    contents.forEach(c => c.classList.toggle('hidden', c.dataset.tabContent !== tabName));
                }
            });
            excelModule.init(panelNode.querySelector('.excel-grid'));
            calendarModule.init(panelNode);
        },
        'idea-mapper': (panelNode) => ideaMapperModule.init(panelNode),
        'data-analysis': (panelNode) => dataAnalysisModule.init(panelNode),
        'quick-links': (panelNode) => quickLinksModule.init(panelNode),
        'quick-note': (panelNode) => quickNoteModule.init(panelNode),
        'calculator': (panelNode) => calculatorModule.init(panelNode),
        'custom-html': (panelNode) => {
            panelNode.querySelector('.render-html-btn').onclick = () => {
                panelNode.querySelector('.custom-html-iframe').srcdoc = panelNode.querySelector('.html-input').value;
            };
        }
    };
    
    // --- Day Dashboard Modal Module ---
    const dayDashboardModule = (() => {
        const modal = document.getElementById('day-modal');
        let calendarData = JSON.parse(localStorage.getItem('calendarData')) || {};
        let activeDateKey = '';
        const save = () => localStorage.setItem('calendarData', JSON.stringify(calendarData));

        const renderItems = (type) => {
            const ul = modal.querySelector(`ul[data-type="${type}"]`);
            ul.innerHTML = '';
            const items = (calendarData[activeDateKey] && calendarData[activeDateKey][type]) ? calendarData[activeDateKey][type] : [];
            items.forEach((itemText, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-slate-700 p-2 rounded';
                li.textContent = itemText;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-400 font-bold px-2';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = () => {
                    calendarData[activeDateKey][type].splice(index, 1);
                    save(); renderItems(type);
                };
                li.appendChild(deleteBtn);
                ul.appendChild(li);
            });
        };

        modal.querySelectorAll('.add-item-btn').forEach(btn => {
            btn.onclick = () => {
                const type = btn.dataset.type;
                const input = btn.previousElementSibling;
                if (input.value.trim()) {
                    if (!calendarData[activeDateKey]) calendarData[activeDateKey] = {};
                    if (!calendarData[activeDateKey][type]) calendarData[activeDateKey][type] = [];
                    calendarData[activeDateKey][type].push(input.value.trim());
                    input.value = '';
                    save();
                    renderItems(type);
                    document.dispatchEvent(new Event('calendar:dataupdated'));
                }
            };
        });

        modal.querySelectorAll('.modal-tab').forEach(tab => {
            tab.onclick = () => {
                modal.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                modal.querySelectorAll('.modal-tab-content').forEach(c => c.classList.add('hidden'));
                modal.querySelector(`.modal-tab-content[data-tab-content="${tab.dataset.tab}"]`).classList.remove('hidden');
            };
        });
        
        document.getElementById('modal-close-btn').onclick = () => modal.classList.add('hidden');

        return {
            show: (dateKey) => {
                activeDateKey = dateKey;
                document.getElementById('modal-date-display').textContent = new Date(dateKey.replace(/-/g, '/')).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                modal.querySelector('.modal-tab').click(); // Reset to first tab
                ['notes', 'goals', 'todos', 'reminders'].forEach(renderItems);
                modal.classList.remove('hidden');
            }
        };
    })();

    // --- Calendar Module ---
    const calendarModule = (() => {
        let currentDate = new Date();
        let calendarData = {};
        let panelNode;

        const load = () => { calendarData = JSON.parse(localStorage.getItem('calendarData')) || {}; };

        const render = () => {
            load();
            const calendarBody = panelNode.querySelector('.calendar tbody');
            const monthYearDisplay = panelNode.querySelector('.month-year-display');
            if (!calendarBody || !monthYearDisplay) return;

            calendarBody.innerHTML = ''; currentDate.setDate(1);
            const month = currentDate.getMonth(), year = currentDate.getFullYear();
            monthYearDisplay.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
            const firstDayIndex = currentDate.getDay(), lastDay = new Date(year, month + 1, 0).getDate();
            
            let date = 1;
            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');
                    if (i === 0 && j < firstDayIndex || date > lastDay) { /* empty */ } 
                    else {
                        const dateKey = `${year}-${month + 1}-${date}`;
                        cell.textContent = date; cell.dataset.dateKey = dateKey;
                        if (calendarData[dateKey] && Object.values(calendarData[dateKey]).some(arr => arr.length > 0)) {
                            cell.classList.add('has-note');
                        }
                        if (date === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) {
                            cell.classList.add('today');
                        }
                        date++;
                    }
                    row.appendChild(cell);
                }
                calendarBody.appendChild(row);
                if (date > lastDay) break;
            }
        };

        return {
            init: (node) => {
                panelNode = node;
                render();
                panelNode.querySelector('.prev-month').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); render(); };
                panelNode.querySelector('.next-month').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); render(); };
                panelNode.querySelector('.calendar tbody').onclick = (e) => {
                    if (e.target.tagName === 'TD' && e.target.dataset.dateKey) {
                        dayDashboardModule.show(e.target.dataset.dateKey);
                    }
                };
                document.addEventListener('calendar:dataupdated', () => render());
            }
        };
    })();

    // --- Excel Module ---
    const excelModule = {
        init: (grid) => {
            if (!grid) return;
            // Create headers
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th></th>' + Array.from({length: 10}, (_, i) => `<th>${String.fromCharCode(65 + i)}</th>`).join('');
            grid.appendChild(headerRow);
            // Create rows
            for(let i = 1; i <= 20; i++) {
                const row = document.createElement('tr');
                row.innerHTML = `<th>${i}</th>` + Array.from({length: 10}, () => `<td contenteditable="true" class="border border-slate-600 p-1"></td>`).join('');
                grid.appendChild(row);
            }
        }
    };

    // --- Idea Mapper Module (using libraries) ---
    const ideaMapperModule = (() => {
        let wrapper, nodes = [], connectors = [], lines = [];
        let state = { connecting: false, startNode: null };

        const save = () => localStorage.setItem('mapperData', JSON.stringify({ nodes, connectors }));
        const load = () => {
            const data = JSON.parse(localStorage.getItem('mapperData'));
            if (data && data.nodes && data.nodes.length) {
                nodes = data.nodes; connectors = data.connectors || [];
            } else {
                nodes = [{ id: `node-${Date.now()}`, x: 50, y: 50, text: 'Start Here' }];
            }
            render();
        };

        const render = () => {
            if (!wrapper) return;
            wrapper.innerHTML = ''; // Clear previous nodes
            lines.forEach(line => line.remove()); lines = [];

            nodes.forEach(nodeData => {
                const nodeEl = document.createElement('div');
                nodeEl.id = nodeData.id;
                nodeEl.className = 'mapper-node';
                nodeEl.style.left = `${nodeData.x}px`;
                nodeEl.style.top = `${nodeData.y}px`;
                nodeEl.textContent = nodeData.text;
                wrapper.appendChild(nodeEl);
                
                new PlainDraggable(nodeEl, {
                    containment: wrapper,
                    onMove: () => lines.forEach(l => l.position()),
                    onDragEnd: (e) => {
                        nodeData.x = e.left; nodeData.y = e.top;
                        save();
                    }
                });
            });
            drawConnectors();
        };

        const drawConnectors = () => {
            lines.forEach(line => line.remove()); lines = [];
            connectors.forEach(conn => {
                const from = document.getElementById(conn.from), to = document.getElementById(conn.to);
                if (from && to) {
                    lines.push(new LeaderLine(from, to, { color: '#94a3b8', size: 2, path: 'straight', startSocket: 'auto', endSocket: 'auto' }));
                }
            });
        };

        return {
            init: (panelNode) => {
                wrapper = panelNode.querySelector('.idea-mapper-wrapper');
                panelNode.querySelector('.add-node-btn').onclick = () => {
                    nodes.push({ id: `node-${Date.now()}`, x: 20, y: 20, text: 'New Idea' });
                    render(); save();
                };
                panelNode.querySelector('.connect-node-btn').onclick = (e) => {
                    state.connecting = !state.connecting;
                    e.target.classList.toggle('bg-green-500', state.connecting);
                    e.target.classList.toggle('bg-slate-600', !state.connecting);
                    if (!state.connecting && state.startNode) {
                        state.startNode.style.boxShadow = ''; state.startNode = null;
                    }
                };
                panelNode.querySelector('.save-map-btn').onclick = () => {
                    html2canvas(wrapper, { backgroundColor: '#1e293b' }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = 'idea-map.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    });
                };
                wrapper.addEventListener('click', (e) => {
                    if (state.connecting && e.target.classList.contains('mapper-node')) {
                        if (!state.startNode) {
                            state.startNode = e.target;
                            e.target.style.boxShadow = '0 0 0 3px #34d399';
                        } else if (state.startNode !== e.target) {
                            connectors.push({ from: state.startNode.id, to: e.target.id });
                            drawConnectors(); save();
                            panelNode.querySelector('.connect-node-btn').click();
                        }
                    }
                });
                wrapper.addEventListener('dblclick', (e) => {
                    if (e.target.classList.contains('mapper-node')) {
                        const newText = prompt('Enter new text:', e.target.textContent);
                        if (newText !== null && newText.trim() !== '') {
                            e.target.textContent = newText;
                            nodes.find(n => n.id === e.target.id).text = newText;
                            save();
                        }
                    }
                });
                load();
            }
        };
    })();

    // --- Other Modules ---
    const dataAnalysisModule = { init: (node) => { /* Placeholder for brevity */ } };
    const quickLinksModule = { init: (node) => {
        node.querySelector('.add-link-btn').onclick = () => {
            const nameEl = node.querySelector('.link-name'), urlEl = node.querySelector('.link-url');
            if (nameEl.value && urlEl.value) {
                const a = document.createElement('a');
                a.href = urlEl.value; a.target = "_blank";
                a.className = 'block p-2 bg-slate-700/50 rounded-md text-center text-sm hover:bg-slate-600/50 truncate';
                a.textContent = nameEl.value;
                node.querySelector('.links-list').appendChild(a);
                nameEl.value = ''; urlEl.value = '';
            }
        };
    } };
    const quickNoteModule = { init: (node) => {
        node.querySelector('.save-note-btn').onclick = () => {
            const wrapper = node.querySelector('.note-wrapper'), current = wrapper.querySelector('.note');
            if (wrapper.querySelector('textarea').value.trim() === '') return;
            current.classList.add('saved');
            setTimeout(() => {
                current.remove();
                const newNote = document.createElement('div');
                newNote.className = 'note';
                newNote.innerHTML = `<textarea class="note-textarea w-full h-full bg-transparent border-none focus:outline-none resize-none p-2" placeholder="Type..."></textarea>`;
                wrapper.appendChild(newNote);
                newNote.querySelector('textarea').focus();
            }, 500);
        };
    } };
    const calculatorModule = { init: (node) => {
        const display = node.querySelector('.calculator-display');
        const grid = node.querySelector('.calculator-grid');
        const module = {
            clear: () => { display.textContent = '0'; },
            input: (val) => {
                if (display.textContent === '0' || display.textContent === 'Error') display.textContent = '';
                if (display.textContent.length > 15) return;
                display.textContent += val;
            },
            equals: () => {
                try { display.textContent = parseFloat(eval(display.textContent.replace(/[^-()\d/*+.]/g, '')).toFixed(5)); } 
                catch (e) { display.textContent = 'Error'; }
            }
        };
        grid.innerHTML = `<button class="pro-button p-2 text-xl">C</button><button class="pro-button p-2 text-xl">(</button><button class="pro-button p-2 text-xl">)</button><button class="pro-button operator p-2 text-xl">/</button>`;
        ['7','8','9','*','4','5','6','-','1','2','3','+','0','.'].forEach(k => {
            const op = '/*-+'.includes(k);
            grid.innerHTML += `<button class="pro-button ${op ? 'operator' : ''} p-2 text-xl">${k}</button>`;
        });
        grid.innerHTML += `<button class="pro-button operator col-span-2 p-2 text-xl">=</button>`;
        grid.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                const key = e.target.textContent;
                if(key === 'C') module.clear();
                else if (key === '=') module.equals();
                else module.input(key);
            }
        });
    } };

    // --- Initialize Dashboard ---
    dashboardModule.init();
});
</script>

</body>
</html>
