<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-panel: #111111;
            --border-color: #2a2a2a;
            --text-primary: #f5f5f5;
            --text-secondary: #a3a3a3;
            --accent-yellow: #facc15;
            --accent-yellow-hover: #fde047;
        }
        html, body { height: 100%; overflow-x: hidden; overflow-y: auto; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); }
        
        #sidebar {
            background: linear-gradient(180deg, rgba(30,30,30,0.85), rgba(10,10,10,0.85));
            border-right: 1px solid var(--border-color);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        #main-content { transition: margin-left 0.3s ease-in-out; height: 100vh; overflow-y: auto; }

        /* Vista-like widget styling */
        .widget {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        @keyframes borderGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.4); }
            50% { box-shadow: 0 0 8px 2px rgba(250, 204, 21, 0.6); }
        }

        .panel {
            background: var(--bg-panel);
            border-radius: 0.75rem; padding: 1.5rem; border: 1px solid var(--border-color);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.5);
            display: flex; flex-direction: column; overflow: hidden;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .panel:hover,
        .panel:focus-within {
            border-color: var(--accent-yellow);
            animation: borderGlow 1.5s ease-in-out infinite;
        }
        .panel-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; flex-shrink: 0; }
        .panel-content { flex-grow: 1; overflow-y: auto; min-height: 0; display: flex; flex-direction: column; }
        
        .pro-button {
            background-color: var(--accent-yellow); color: var(--bg-primary); font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .pro-button:hover { background-color: var(--accent-yellow-hover); }
        .pro-button:active { transform: scale(0.95); }
        .pro-input, .pro-select { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.875rem; color: var(--text-primary); }

        .main-tab { border-bottom: 2px solid transparent; cursor: pointer; transition: color 0.2s ease, border-color 0.2s ease; }
        .main-tab.active { color: var(--accent-yellow); border-bottom-color: var(--accent-yellow); }
        .main-tab:hover { color: var(--accent-yellow); }

        .file-toolbar { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; flex-shrink: 0; }
        .file-toolbar button {
            background-color: #334155; padding: 0.25rem 0.75rem; font-size: 0.75rem; border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .file-toolbar button:hover { background-color: #475569; }
        .file-toolbar button:active { transform: scale(0.95); }

        .tab-button {
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
        }
        .tab-button:hover { background-color: rgba(250, 204, 21, 0.15); color: var(--accent-yellow); }
        .tab-button:active { transform: scale(0.95); }

        /* Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-grid div { text-align: center; padding: 0.5rem; border: 1px solid var(--border-color); }
        .calendar-grid div.has-note { background-color: rgba(250, 204, 21, 0.15); }
        .calendar-grid div.today { outline: 2px solid var(--accent-yellow); }

        .file-list li { cursor: pointer; }

        /* Day Modal */
        .modal-overlay { background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: var(--bg-panel); }

        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-950 min-h-screen">

    <div id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-slate-900/80 backdrop-blur-lg p-4 transform -translate-x-full md:translate-x-0 flex flex-col">
        <h1 class="text-2xl font-bold mb-6 text-yellow-300">Dashboard Pro</h1>
        <button id="sidebar-close" class="md:hidden absolute top-4 right-4 p-2 bg-slate-800 rounded-md">&times;</button>
        <div id="sidebar-tools" class="flex-grow overflow-y-auto space-y-4">
            <!-- Sidebar widgets will be injected here -->
        </div>
    </div>

    <div id="main-content" class="md:ml-72 h-full flex flex-col p-4">
        <button id="sidebar-toggle" class="md:hidden fixed top-4 left-4 z-40 p-2 bg-slate-800 rounded-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
        <div class="flex-shrink-0 mb-4">
            <div class="flex space-x-4 border-b border-gray-700">
                <button id="editor-suite-tab-btn" class="main-tab py-2 px-4 text-lg font-semibold active">Editor</button>
                <button id="files-tab-btn" class="main-tab py-2 px-4 text-lg font-semibold">Files</button>
            </div>
        </div>
        <div id="workspace" class="flex-grow relative">
            <!-- Main workspace panels will go here -->
        </div>
    </div>
    
    <!-- Panel Templates -->
    <template id="panel-template-editor-suite">
        <div class="panel h-full">
            <h2 class="panel-title">Editor Suite</h2>
            <div class="file-toolbar"><button class="file-new">New</button><button class="file-save">Save</button><button class="file-open">Open</button><button class="file-undo">Undo</button><button class="file-redo">Redo</button></div>
            <div class="editor-tabs flex space-x-1 bg-slate-700/50 p-1 rounded-lg mb-4 flex-shrink-0">
                <button data-tab="word" class="tab-button px-3 py-1 text-sm font-medium rounded-md active">Word</button>
                <button data-tab="excel" class="tab-button px-3 py-1 text-sm font-medium rounded-md">Excel</button>
                <button data-tab="calendar" class="tab-button px-3 py-1 text-sm font-medium rounded-md">Calendar</button>
            </div>
            <div class="panel-content">
                <div class="tab-content flex-grow flex flex-col" data-tab-content="word"><div class="editor-toolbar flex-shrink-0"><button onclick="document.execCommand('bold')" class="font-bold">B</button> <button onclick="document.execCommand('italic')" class="italic">I</button></div><div class="editor-container flex-grow overflow-auto" contenteditable="true"></div></div>
                <div class="tab-content hidden flex-grow flex flex-col" data-tab-content="excel"><div class="editor-container flex-grow overflow-auto"><table class="excel-grid w-full"></table></div></div>
                <div class="tab-content hidden flex-grow flex flex-col" data-tab-content="calendar"><div class="calendar-controls flex justify-between items-center mb-4"><button class="prev-month pro-button">&lt;</button><h3 class="month-year-display font-bold"></h3><div class="flex space-x-2"><button class="sync-google pro-button">Sync</button><button class="next-month pro-button">&gt;</button></div></div><div class="calendar-grid w-full text-sm"></div></div>
            </div>
        </div>
    </template>

    <template id="panel-template-files">
        <div class="panel h-full">
            <h2 class="panel-title">File Manager</h2>
            <div class="panel-content flex h-full">
                <ul class="file-list w-1/3 pr-2 border-r overflow-y-auto space-y-1"></ul>
                <div class="flex-1 flex flex-col pl-2">
                    <input class="file-name pro-input mb-2" placeholder="File name">
                    <div class="editor-container flex-grow overflow-auto bg-slate-800 p-2 rounded" contenteditable="true"></div>
                    <div class="flex space-x-2 mt-2 flex-shrink-0">
                        <button class="save-file pro-button">Save</button>
                        <button class="delete-file pro-button bg-red-600">Delete</button>
                        <button class="download-file pro-button bg-teal-600">Download</button>
                        <button class="print-file pro-button bg-blue-600">Print</button>
                    </div>
                    <div class="h-40 mt-4"><canvas class="file-chart"></canvas></div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="sidebar-tool-template">
        <div class="sidebar-tool widget p-3 rounded-lg cursor-grab">
            <h3 class="font-semibold text-yellow-300"></h3>
            <div class="sidebar-tool-content mt-2"></div>
        </div>
    </template>

    <!-- Day Dashboard Modal -->
    <div id="day-modal" class="modal-overlay fixed inset-0 w-full h-full flex items-center justify-center hidden z-50">
        <div class="modal-content w-full max-w-2xl p-6 rounded-lg shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-date-display" class="text-xl font-bold"></h3>
                <button id="modal-close-btn" class="text-2xl">&times;</button>
            </div>
            <div class="flex border-b border-slate-600 mb-4">
                <button class="modal-tab p-2 px-4 active" data-tab="notes">Notes</button>
                <button class="modal-tab p-2 px-4" data-tab="goals">Goals</button>
                <button class="modal-tab p-2 px-4" data-tab="todos">To-Do</button>
                <button class="modal-tab p-2 px-4" data-tab="reminders">Reminders</button>
            </div>
            <div class="modal-tab-content" data-tab-content="notes"><div class="flex space-x-2"><input type="text" class="pro-input flex-grow" placeholder="New note..."><button class="pro-button add-item-btn" data-type="notes">+</button></div><ul class="item-list mt-2 space-y-1" data-type="notes"></ul></div>
            <div class="modal-tab-content hidden" data-tab-content="goals"><div class="flex space-x-2"><input type="text" class="pro-input flex-grow" placeholder="New goal..."><button class="pro-button add-item-btn" data-type="goals">+</button></div><ul class="item-list mt-2 space-y-1" data-type="goals"></ul></div>
            <div class="modal-tab-content hidden" data-tab-content="todos"><div class="flex space-x-2"><input type="text" class="pro-input flex-grow" placeholder="New to-do..."><button class="pro-button add-item-btn" data-type="todos">+</button></div><ul class="item-list mt-2 space-y-1" data-type="todos"></ul></div>
            <div class="modal-tab-content hidden" data-tab-content="reminders"><div class="flex space-x-2"><input type="text" class="pro-input flex-grow reminder-text" placeholder="Reminder..."><input type="datetime-local" class="pro-input reminder-time"><button class="pro-button add-item-btn" data-type="reminders">+</button></div><ul class="item-list mt-2 space-y-1" data-type="reminders"></ul></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    if ('Notification' in window && Notification.permission !== 'granted') {
        Notification.requestPermission();
    }
    const workspace = document.getElementById('workspace');
    const sidebarToolsContainer = document.getElementById('sidebar-tools');
    
    const availableTools = [
        { id: 'data-analysis', name: 'Data Analysis' },
        { id: 'quick-links', name: 'Quick Links' },
        { id: 'quick-note', name: 'Quick Note' },
        { id: 'calculator', name: 'Calculator' },
        { id: 'custom-html', name: 'Custom HTML' },
    ];

    // --- Core Dashboard Logic ---
    const dashboardModule = (() => {
        const renderSidebarTools = () => {
            availableTools.forEach(tool => {
                const template = document.getElementById('sidebar-tool-template');
                const toolNode = template.content.cloneNode(true).firstElementChild;
                toolNode.querySelector('h3').textContent = tool.name;
                toolNode.dataset.toolId = tool.id;
                const content = toolNode.querySelector('.sidebar-tool-content');

                switch (tool.id) {
                    case 'quick-note':
                        content.innerHTML = `<div class="note-wrapper h-32 bg-slate-700 rounded-md overflow-hidden"><div class="note h-full"><textarea class="note-textarea w-full h-full bg-transparent border-none focus:outline-none resize-none p-2" placeholder="Type..."></textarea></div></div><button class="save-note-btn pro-button w-full mt-2">Save</button><ul class="saved-notes mt-2 space-y-1 text-xs"></ul>`;
                        quickNoteModule.init(toolNode);
                        break;
                    case 'calculator':
                        content.innerHTML = `<div class="calculator-display bg-slate-800 rounded-md p-2 text-right text-xl mb-2">0</div><div class="calculator-grid grid grid-cols-4 gap-2"></div>`;
                        calculatorModule.init(toolNode);
                        break;
                    case 'quick-links':
                        content.innerHTML = `<div class="flex space-x-1 mb-2"><input type="text" class="link-name pro-input flex-grow" placeholder="Name"><input type="url" class="link-url pro-input flex-grow" placeholder="URL"><button class="add-link-btn pro-button">+</button></div><div class="links-list space-y-1"></div>`;
                        quickLinksModule.init(toolNode);
                        break;
                    case 'data-analysis':
                        content.innerHTML = `<textarea class="data-input pro-input w-full h-24 mb-2" placeholder="Enter numbers separated by commas"></textarea><button class="analyze-btn pro-button w-full mb-2">Analyze</button><div class="analysis-result text-sm text-slate-400"></div>`;
                        dataAnalysisModule.init(toolNode);
                        break;
                    case 'custom-html':
                        content.innerHTML = `<textarea class="html-input pro-input w-full h-24 mb-2" placeholder="<p>Custom HTML</p>"></textarea><button class="render-btn pro-button w-full mb-2">Render</button><div class="html-preview mt-2"></div>`;
                        customHTMLModule.init(toolNode);
                        break;
                }

                sidebarToolsContainer.appendChild(toolNode);
            });
        };

        const setActiveTab = (tab) => {
            workspace.innerHTML = '';
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`${tab}-tab-btn`).classList.add('active');
            
            const template = document.getElementById(`panel-template-${tab}`);
            if (template) {
                const panelNode = template.content.cloneNode(true).firstElementChild;
                workspace.appendChild(panelNode);
                if (panelInitializers[tab]) {
                    panelInitializers[tab](panelNode);
                }
            }
        };

        document.getElementById('editor-suite-tab-btn').onclick = () => setActiveTab('editor-suite');
        document.getElementById('files-tab-btn').onclick = () => setActiveTab('files');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarClose = document.getElementById('sidebar-close');
        sidebarToggle.addEventListener('click', () => { sidebar.classList.remove('-translate-x-full'); sidebarToggle.classList.add('hidden'); });
        sidebarClose.addEventListener('click', () => { sidebar.classList.add('-translate-x-full'); sidebarToggle.classList.remove('hidden'); });

        return { init: () => { renderSidebarTools(); setActiveTab('editor-suite'); } };
    })();

    // --- Panel Initializers ---
    const panelInitializers = {
        'editor-suite': (panelNode) => {
            const tabs = panelNode.querySelector('.editor-tabs');
            const contents = panelNode.querySelectorAll('.tab-content');
            tabs.addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') {
                    const tabName = e.target.dataset.tab;
                    tabs.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    contents.forEach(c => c.classList.toggle('hidden', c.dataset.tabContent !== tabName));
                }
            });

            const toolbar = panelNode.querySelector('.file-toolbar');
            const wordEditor = panelNode.querySelector('[data-tab-content="word"] .editor-container');
            const excelGrid = panelNode.querySelector('.excel-grid');
            const activeTab = () => panelNode.querySelector('.editor-tabs .active').dataset.tab;

            toolbar.querySelector('.file-new').onclick = () => {
                const tab = activeTab();
                if (tab === 'word') {
                    wordEditor.innerHTML = '';
                } else if (tab === 'excel') {
                    excelGrid.querySelectorAll('td').forEach(td => td.textContent = '');
                }
            };

            toolbar.querySelector('.file-save').onclick = () => {
                const tab = activeTab();
                if (tab === 'word') {
                    const blob = new Blob([wordEditor.innerHTML], { type: 'text/html' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'document.html';
                    a.click();
                    URL.revokeObjectURL(a.href);
                } else if (tab === 'excel') {
                    const rows = [];
                    excelGrid.querySelectorAll('tr').forEach((tr, idx) => {
                        if (idx === 0) return;
                        const cols = [];
                        tr.querySelectorAll('td').forEach(td => cols.push(td.textContent));
                        rows.push(cols.join(','));
                    });
                    const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'sheet.csv';
                    a.click();
                    URL.revokeObjectURL(a.href);
                }
            };

            toolbar.querySelector('.file-open').onclick = () => {
                const tab = activeTab();
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = tab === 'word' ? '.txt,.html' : '.csv';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = ev => {
                        if (tab === 'word') {
                            wordEditor.innerHTML = ev.target.result;
                        } else if (tab === 'excel') {
                            const lines = ev.target.result.split(/\r?\n/);
                            excelGrid.querySelectorAll('tr').forEach((tr, rIdx) => {
                                if (rIdx === 0) return;
                                const cells = lines[rIdx - 1] ? lines[rIdx - 1].split(',') : [];
                                tr.querySelectorAll('td').forEach((td, cIdx) => td.textContent = cells[cIdx] || '');
                            });
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };

            toolbar.querySelector('.file-undo').onclick = () => document.execCommand('undo');
            toolbar.querySelector('.file-redo').onclick = () => document.execCommand('redo');

            excelModule.init(excelGrid);
            calendarModule.init(panelNode);
        },
        'files': (panelNode) => fileManagerModule.init(panelNode),
    };
    
    // --- Day Dashboard Modal Module ---
    const dayDashboardModule = (() => {
        const modal = document.getElementById('day-modal');
        let calendarData = JSON.parse(localStorage.getItem('calendarData')) || {};
        let activeDateKey = '';
        const save = () => localStorage.setItem('calendarData', JSON.stringify(calendarData));

        const scheduleReminder = (dateKey, reminder) => {
            if (!('Notification' in window)) return;
            const when = new Date(`${dateKey}T${reminder.time}`);
            const timeout = when.getTime() - Date.now();
            if (timeout > 0) {
                setTimeout(() => {
                    new Notification('Reminder', { body: reminder.text });
                }, timeout);
            }
        };

        const renderItems = (type) => {
            const ul = modal.querySelector(`ul[data-type="${type}"]`);
            ul.innerHTML = '';
            const items = (calendarData[activeDateKey] && calendarData[activeDateKey][type]) ? calendarData[activeDateKey][type] : [];
            items.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-slate-700 p-2 rounded';
                const display = type === 'reminders'
                    ? `${item.text} (${new Date(item.time).toLocaleString()})`
                    : item;
                li.textContent = display;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-400 font-bold px-2';
                deleteBtn.innerHTML = '&times;';
                deleteBtn.onclick = () => {
                    calendarData[activeDateKey][type].splice(index, 1);
                    save(); renderItems(type);
                };
                li.appendChild(deleteBtn);
                ul.appendChild(li);
            });
        };

        Object.entries(calendarData).forEach(([dateKey, types]) => {
            (types.reminders || []).forEach(r => scheduleReminder(dateKey, r));
        });
        modal.querySelectorAll('.add-item-btn').forEach(btn => {
            btn.onclick = () => {
                const type = btn.dataset.type;
                const container = btn.parentElement;
                const textInput = container.querySelector('.reminder-text') || container.querySelector('input[type="text"]');
                const timeInput = container.querySelector('.reminder-time');
                if (type === 'reminders') {
                    if (textInput.value.trim() && timeInput.value) {
                        if (!calendarData[activeDateKey]) calendarData[activeDateKey] = {};
                        if (!calendarData[activeDateKey][type]) calendarData[activeDateKey][type] = [];
                        const reminder = { text: textInput.value.trim(), time: timeInput.value };
                        calendarData[activeDateKey][type].push(reminder);
                        scheduleReminder(activeDateKey, reminder);
                        textInput.value = '';
                        timeInput.value = '';
                        save();
                        renderItems(type);
                        document.dispatchEvent(new Event('calendar:dataupdated'));
                    }
                } else {
                    if (textInput.value.trim()) {
                        if (!calendarData[activeDateKey]) calendarData[activeDateKey] = {};
                        if (!calendarData[activeDateKey][type]) calendarData[activeDateKey][type] = [];
                        calendarData[activeDateKey][type].push(textInput.value.trim());
                        textInput.value = '';
                        save();
                        renderItems(type);
                        document.dispatchEvent(new Event('calendar:dataupdated'));
                    }
                }
            };
        });

        modal.querySelectorAll('.modal-tab').forEach(tab => {
            tab.onclick = () => {
                modal.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                modal.querySelectorAll('.modal-tab-content').forEach(c => c.classList.add('hidden'));
                modal.querySelector(`.modal-tab-content[data-tab-content="${tab.dataset.tab}"]`).classList.remove('hidden');
            };
        });
        
        document.getElementById('modal-close-btn').onclick = () => modal.classList.add('hidden');

        return {
            show: (dateKey) => {
                activeDateKey = dateKey;
                document.getElementById('modal-date-display').textContent = new Date(dateKey.replace(/-/g, '/')).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                modal.querySelector('.modal-tab').click(); // Reset to first tab
                ['notes', 'goals', 'todos', 'reminders'].forEach(renderItems);
                modal.classList.remove('hidden');
            }
        };
    })();

    const googleCalendarModule = (() => {
        const CLIENT_ID = 'YOUR_CLIENT_ID';
        const API_KEY = 'YOUR_API_KEY';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.readonly';
        let tokenClient;
        let gapiInited = false;

        const loadGapiClient = () => new Promise(resolve => {
            gapi.load('client', async () => {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
                gapiInited = true;
                resolve();
            });
        });

        const sync = async (calendarData, currentDate) => {
            if (!gapiInited) await loadGapiClient();
            if (!tokenClient) {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: ''
                });
            }
            tokenClient.callback = async (resp) => {
                if (resp.error) return;
                const start = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString();
                const end = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).toISOString();
                const events = await gapi.client.calendar.events.list({
                    calendarId: 'primary',
                    timeMin: start,
                    timeMax: end,
                    showDeleted: false,
                    singleEvents: true,
                    orderBy: 'startTime'
                });
                events.result.items.forEach(ev => {
                    const dateStr = ev.start.date || ev.start.dateTime.split('T')[0];
                    const parts = dateStr.split('-').map(Number);
                    const dateKey = `${parts[0]}-${parts[1]}-${parts[2]}`;
                    if (!calendarData[dateKey]) calendarData[dateKey] = {};
                    if (!calendarData[dateKey].events) calendarData[dateKey].events = [];
                    calendarData[dateKey].events.push(ev.summary || 'Event');
                });
                localStorage.setItem('calendarData', JSON.stringify(calendarData));
                document.dispatchEvent(new Event('calendar:dataupdated'));
            };
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        };

        return { sync };
    })();

    // --- Calendar Module ---
    const calendarModule = (() => {
        let currentDate = new Date();
        let calendarData = {};
        let panelNode;

        currentDate.setDate(1);

        const load = () => { calendarData = JSON.parse(localStorage.getItem('calendarData')) || {}; };

        const render = () => {
            load();
            const grid = panelNode.querySelector('.calendar-grid');
            const monthYearDisplay = panelNode.querySelector('.month-year-display');
            if (!grid || !monthYearDisplay) return;

            grid.innerHTML = '';
            const month = currentDate.getMonth(), year = currentDate.getFullYear();
            monthYearDisplay.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
            const firstDayIndex = new Date(year, month, 1).getDay();
            const lastDay = new Date(year, month + 1, 0).getDate();

            const days = ['Su','Mo','Tu','We','Th','Fr','Sa'];
            days.forEach(d => { const head = document.createElement('div'); head.className = 'font-bold'; head.textContent = d; grid.appendChild(head); });
            for (let i = 0; i < firstDayIndex; i++) grid.appendChild(document.createElement('div'));
            for (let date = 1; date <= lastDay; date++) {
                const cell = document.createElement('div');
                const dateKey = `${year}-${month + 1}-${date}`;
                cell.textContent = date; cell.dataset.dateKey = dateKey;
                if (calendarData[dateKey] && Object.values(calendarData[dateKey]).some(arr => arr.length > 0)) {
                    cell.classList.add('has-note');
                }
                if (date === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()) {
                    cell.classList.add('today');
                }
                grid.appendChild(cell);
            }
        };

        return {
            init: (node) => {
                panelNode = node;
                render();
                panelNode.querySelector('.prev-month').onclick = () => {
                    currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
                    render();
                };
                panelNode.querySelector('.next-month').onclick = () => {
                    currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
                    render();
                };
                panelNode.querySelector('.sync-google').onclick = () => { googleCalendarModule.sync(calendarData, currentDate); };
                panelNode.querySelector('.calendar-grid').onclick = (e) => {
                    if (e.target.dataset.dateKey) {
                        dayDashboardModule.show(e.target.dataset.dateKey);
                    }
                };
                document.addEventListener('calendar:dataupdated', () => render());
            }
        };
    })();

    // --- Excel Module ---
    const excelModule = {
        init: (grid) => {
            if (!grid) return;
            // Create headers
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th></th>' + Array.from({length: 10}, (_, i) => `<th>${String.fromCharCode(65 + i)}</th>`).join('');
            grid.appendChild(headerRow);
            // Create rows
            for(let i = 1; i <= 20; i++) {
                const row = document.createElement('tr');
                row.innerHTML = `<th>${i}</th>` + Array.from({length: 10}, () => `<td contenteditable="true" class="border border-slate-600 p-1"></td>`).join('');
                grid.appendChild(row);
            }
        }
    };

    // --- File Manager Module ---
    const fileManagerModule = (() => {
        let files = [], list, nameInput, editor, chart, chartCtx;
        const save = () => localStorage.setItem('savedFiles', JSON.stringify(files));
        const load = () => { files = JSON.parse(localStorage.getItem('savedFiles')) || []; };
        const renderList = () => {
            list.innerHTML = '';
            files.forEach(f => {
                const li = document.createElement('li');
                li.className = 'p-2 bg-slate-700 rounded';
                li.textContent = f.name;
                li.dataset.id = f.id;
                list.appendChild(li);
            });
            updateChart();
        };
        const updateChart = () => {
            if (!chartCtx) return;
            if (chart) chart.destroy();
            chart = new Chart(chartCtx, {
                type: 'bar',
                data: { labels: files.map(f => f.name), datasets: [{ label: 'Characters', data: files.map(f => f.content.length), backgroundColor: 'rgba(250,204,21,0.5)' }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        };
        const openFile = (id) => {
            const f = files.find(x => x.id === id);
            if (f) {
                nameInput.value = f.name;
                editor.innerHTML = f.content;
                editor.dataset.id = id;
            }
        };
        return {
            init: (panelNode) => {
                list = panelNode.querySelector('.file-list');
                nameInput = panelNode.querySelector('.file-name');
                editor = panelNode.querySelector('.editor-container');
                chartCtx = panelNode.querySelector('.file-chart').getContext('2d');
                const saveBtn = panelNode.querySelector('.save-file');
                const deleteBtn = panelNode.querySelector('.delete-file');
                const downloadBtn = panelNode.querySelector('.download-file');
                const printBtn = panelNode.querySelector('.print-file');
                load();
                renderList();
                list.addEventListener('click', e => { if (e.target.dataset.id) openFile(e.target.dataset.id); });
                saveBtn.onclick = () => {
                    const name = nameInput.value.trim() || 'Untitled';
                    const content = editor.innerHTML;
                    const id = editor.dataset.id;
                    if (id) {
                        const f = files.find(x => x.id === id);
                        if (f) { f.name = name; f.content = content; }
                    } else {
                        files.push({ id: Date.now().toString(), name, content });
                        editor.dataset.id = files[files.length - 1].id;
                    }
                    save();
                    renderList();
                };
                deleteBtn.onclick = () => {
                    const id = editor.dataset.id;
                    if (!id) return;
                    files = files.filter(f => f.id !== id);
                    editor.dataset.id = '';
                    nameInput.value = '';
                    editor.innerHTML = '';
                    save();
                    renderList();
                };
                downloadBtn.onclick = () => {
                    const name = nameInput.value.trim() || 'file';
                    const blob = new Blob([editor.innerHTML], { type: 'text/html' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `${name}.html`;
                    a.click();
                    URL.revokeObjectURL(a.href);
                };
                printBtn.onclick = () => {
                    const w = window.open('', '', 'width=800,height=600');
                    w.document.write(editor.innerHTML);
                    w.document.close();
                    w.print();
                    w.close();
                };
            }
        };
    })();

    // --- Other Modules ---

    const quickLinksModule = { init: (node) => {
        node.querySelector('.add-link-btn').onclick = () => {
            const nameEl = node.querySelector('.link-name'), urlEl = node.querySelector('.link-url');
            if (nameEl.value && urlEl.value) {
                const a = document.createElement('a');
                a.href = urlEl.value; a.target = "_blank";
                a.className = 'block p-2 bg-slate-700/50 rounded-md text-center text-sm hover:bg-slate-600/50 truncate';
                a.textContent = nameEl.value;
                node.querySelector('.links-list').appendChild(a);
                nameEl.value = ''; urlEl.value = '';
            }
        };
    } };
    const quickNoteModule = { init: (node) => {
        const list = node.querySelector('.saved-notes');
        const textarea = node.querySelector('.note-textarea');
        let editId = null;
        const load = () => {
            const notes = JSON.parse(localStorage.getItem('quickNotes')) || [];
            list.innerHTML = '';
            notes.forEach(n => {
                const li = document.createElement('li');
                li.className = 'bg-slate-800 p-1 rounded flex justify-between items-center';
                const span = document.createElement('span');
                span.textContent = n.text;
                li.appendChild(span);
                const actions = document.createElement('div');
                const editBtn = document.createElement('button');
                editBtn.className = 'text-blue-400 text-xs mr-1';
                editBtn.textContent = 'Edit';
                editBtn.onclick = () => { textarea.value = n.text; editId = n.id; };
                const delBtn = document.createElement('button');
                delBtn.className = 'text-red-400 text-xs';
                delBtn.textContent = 'Del';
                delBtn.onclick = () => {
                    const notes = JSON.parse(localStorage.getItem('quickNotes')) || [];
                    const idx = notes.findIndex(x => x.id === n.id);
                    if (idx > -1) { notes.splice(idx, 1); localStorage.setItem('quickNotes', JSON.stringify(notes)); }
                    if (editId === n.id) { editId = null; textarea.value = ''; }
                    load();
                };
                actions.appendChild(editBtn);
                actions.appendChild(delBtn);
                li.appendChild(actions);
                list.appendChild(li);
            });
        };
        const save = () => {
            const text = textarea.value.trim();
            if (!text) return;
            const notes = JSON.parse(localStorage.getItem('quickNotes')) || [];
            if (editId) {
                const note = notes.find(n => n.id === editId);
                if (note) note.text = text;
                editId = null;
            } else {
                notes.push({ id: Date.now(), text });
            }
            localStorage.setItem('quickNotes', JSON.stringify(notes));
            textarea.value = '';
            load();
        };
        node.querySelector('.save-note-btn').onclick = save;
        load();
    } };
    const calculatorModule = { init: (node) => {
        const display = node.querySelector('.calculator-display');
        const grid = node.querySelector('.calculator-grid');
        const module = {
            clear: () => { display.textContent = '0'; },
            input: (val) => {
                if (display.textContent === '0' || display.textContent === 'Error') display.textContent = '';
                if (display.textContent.length > 15) return;
                display.textContent += val;
            },
            equals: () => {
                try { display.textContent = parseFloat(eval(display.textContent.replace(/[^-()\d/*+.]/g, '')).toFixed(5)); } 
                catch (e) { display.textContent = 'Error'; }
            }
        };
        grid.innerHTML = `<button class="pro-button p-2 text-xl">C</button><button class="pro-button p-2 text-xl">(</button><button class="pro-button p-2 text-xl">)</button><button class="pro-button operator p-2 text-xl">/</button>`;
        ['7','8','9','*','4','5','6','-','1','2','3','+','0','.'].forEach(k => {
            const op = '/*-+'.includes(k);
            grid.innerHTML += `<button class="pro-button ${op ? 'operator' : ''} p-2 text-xl">${k}</button>`;
        });
        grid.innerHTML += `<button class="pro-button operator col-span-2 p-2 text-xl">=</button>`;
        grid.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                const key = e.target.textContent;
                if(key === 'C') module.clear();
                else if (key === '=') module.equals();
                else module.input(key);
            }
        });
    } };

    const dataAnalysisModule = { init: (node) => {
        const input = node.querySelector('.data-input');
        const result = node.querySelector('.analysis-result');
        node.querySelector('.analyze-btn').onclick = () => {
            const numbers = input.value.split(/[,\s]+/).map(Number).filter(n => !isNaN(n));
            if (numbers.length === 0) {
                result.textContent = 'Enter valid numbers';
                return;
            }
            const sum = numbers.reduce((a, b) => a + b, 0);
            const avg = sum / numbers.length;
            result.textContent = `Count: ${numbers.length} Sum: ${sum} Avg: ${avg}`;
        };
    } };

    const customHTMLModule = { init: (node) => {
        const input = node.querySelector('.html-input');
        const preview = node.querySelector('.html-preview');
        node.querySelector('.render-btn').onclick = () => {
            preview.innerHTML = input.value;
        };
    } };

    // --- Initialize Dashboard ---
    dashboardModule.init();
});
</script>

</body>
</html>

